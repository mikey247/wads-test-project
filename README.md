# Django/Wagtail Setup Notes

## System Libraries

These are required libraries in addition to standard ones such as Apache2 and Python 3 (3.4)

For Apache2 Server, use mod_wsgi for Python 3 (seperate package to the Python 2.7 one)

    apt install apache2-dev
    apt install python-letsencrypt-apache
    apt install python-psycopg2
    apt install build-essential binutils-doc autoconf flex bison libjpeg-dev
    apt install libfreetype6-dev zlib1g-dev libzmq3-dev libgdbm-dev libncurses5-dev
    apt install automake libtool libffi-dev curl git tmux gettext
    apt install postgresql-9.6 postgresql-contrib-9.6 postgresql-doc-9.6 postgresql-server-dev-9.6 // or closest version
    apt install redis-server
    apt install python3-yaml libyaml-dev

**Note: YAML required if planning to use YAML format for fixtures**

Optional for dev mode and testing of Django/Wagtail default database setting:

    apt install sqlite3
    apt install sqlitebrowser

**Note: Connection refused is likely when wrong version is installed (see above).**
	
## Virtual Environment

Create a virtual environment to hold the required version of Python and necessary modules e.g.,

    cd /var/www/wagtail
    virtualenv -p /usr/bin/python3 wagtail-env
    source wagtail-env/bin/activate
	mkdir siteroot
	
## Install Django, Wagtail and Additional Modules

    cd /var/www/wagtail/siteroot
    pip install -r requirements.txt

## Setup Apache2 config

### WSGI Module configuration

Optionally install the pip version of mod_wsgi, which is more up-to-date than the standard Ubuntu release.

    cd /var/www/wagtail
    source wagtail-env/bin/activate
    pip install mod_wsgi

Capture the output from the following command:

    sudo -i
    cd /var/www/wagtail/wagtail-env
    source bin/activate
    bin/mod_wsgi-express install-module
    
Which will produce output like:

    LoadModule wsgi_module "/usr/lib/apache2/modules/mod_wsgi-py35.cpython-35m-x86_64-linux-gnu.so"
    WSGIPythonHome "/var/www/wagtail/wagtail-env"

Create the Apache2 module files `/etc/apache2/mods-available/wsgi_express.conf` and `/etc/apache2/mods-available/wsgi_express.load`. Place the `WSGIPythonHome` line in the .conf file and the `LoadModule` line in the .load file.

Enable the new module:

    sudo a2enmod wsgi_express

### Site configurations

Create `/etc/apache2/sites-available/wagtail-le-ssl.conf` for HTTPS site

Use *WSGIDaemonProcess* to specify the python path to the site and the virtualenv

Note: SSL content generated by certbot-auto with Let's Encrypt CA

```
#!Apache Config

<IfModule mod_ssl.c>
<VirtualHost *:443>

    ServerName <your-host>

    Alias /robots.txt /var/www/wagtail/siteroot/static/robots.txt
    Alias /favicon.ico /var/www/wagtail/siteroot/static/favicon.ico

    Alias /media /var/www/wagtail/siteroot/media/
    Alias /static /var/www/wagtail/siteroot/static/

    <Directory /var/www/wagtail/siteroot/static>
        Require all granted
    </Directory>

    <Directory /var/www/wagtail/siteroot/media>
        Require all granted
    </Directory>

    <Directory /var/www/wagtail/siteroot/sitecore>
        <Files wsgi.py>
	    Require all granted
	</Files>
    </Directory>

    # Use python-home as preferred method; alternative fails on some Python/wsgi versions

    WSGIDaemonProcess wagtailapp python-home=/var/www/wagtail/wagtail-env python-path=/var/www/wagtail/siteroot
    WSGIProcessGroup wagtailapp
    WSGIScriptAlias / /var/www/wagtail/siteroot/siteconfig/wsgi.py process-group=wagtailapp

    LogLevel warn
    ErrorLog /var/log/apache2/wagtail-error_log
    CustomLog /var/log/apache2/wagtail-access_log common

    # SSLCertificateFile /etc/letsencrypt/live/<your-host>/cert.pem
    # SSLCertificateKeyFile /etc/letsencrypt/live/<your-host>/privkey.pem
    # Include /etc/letsencrypt/options-ssl-apache.conf
    # SSLCertificateChainFile /etc/letsencrypt/live/<your-host>/chain.pem

</VirtualHost>
</IfModule>
```

Create `/etc/apache2/sites-available/wagtail.conf` for HTTP redirect

```
#!Apache Config
<VirtualHost your.fqdn:80>

  ServerName your.fqdn

  Alias /.well-known/ /var/www/wagtail/siteroot/static/.well-known/
  <Directory /var/www/wagtail/siteroot/static/.well-known/>
     Require all granted
  </Directory>

  LogLevel warn
  ErrorLog /var/log/apache2/wagtail-error_log
  CustomLog /var/log/apache2/wagtail-access_log common

  # RewriteEngine on
  # RewriteCond %{SERVER_NAME} =your.fqdn
  # RewriteRule ^ https://%{SERVER_NAME}%{REQUEST_URI} [END,NE,R=permanent]
</VirtualHost>
```

Create the directory `/var/www/wagtail/siteroot/static/.well-known` to let the SSL certbot place webroot tests.

## SSL Certificate

Enable the SSL module:

    sudo a2enmod ssl

Enable the sites:

    sudo a2ensite wagtail.conf
    sudo a2ensite wagtail-le-ssl.conf
    sudo service apache2 restart

Ensure the firewall is open for ports 80 and 443 (HTTP and HTTPS traffic) so that the CA challenges can be made.

Run certbot to obtain the SSL certificate:

    sudo certbot --authenticator webroot --installer apache

1. When asked, select the site (your.fqdn) you wish to acquire a certificate for.
1. Select the option to enter the webroot.
1. Provide the file system path the directory containing the `.well-known/` directory e.g., `/var/www/wagtail/siteroot/static`
1. Choose whether or not to redirect HTTP to HTTPS (recommended)

Assuming the challenges succeeded, both of the Apache configurations should have been modified by the certbot script, producing content similar to the commented `SSLCertificate` code and `Rewrite` lines in the configurations above. They should point to newly created certificates in `/etc/letsencrpyt/live/your.fqdn/*`.

## Django/Wagtail Configuration

### Prepare development or production mode

Default `/var/www/wagtail/siteroot/siteconfig/wsgi.py` is good as is for development mode, but requires a minor edit for production mode:

    #os.environ.setdefault("DJANGO_SETTINGS_MODULE", "sitecore.settings.dev")
    os.environ.setdefault("DJANGO_SETTINGS_MODULE", "sitecore.settings.production")

### Configure postgresql for wagtail app

	su - postgres
	psql
	postgres=#
		CREATE DATABASE wagtail;
		CREATE USER wagtail WITH PASSWORD '***********';
		ALTER ROLE wagtail SET client_encoding TO 'utf8';
		ALTER ROLE wagtail SET default_transaction_isolation TO 'read committed';
		ALTER ROLE wagtail SET timezone TO 'UTC';
		GRANT ALL PRIVILEGES ON DATABASE wagtail TO wagtail;
		\q
	exit


### Configure local settings

Generate a new SECRET_KEY at http://www.miniwebtool.com/django-secret-key-generator/ and using the `siteconfig/settings/local.template` file, create `siteconfig/settings/local.py` and edit the required fields to set/confirm:

* SECRET_KEY
* SECURE_SSL_REDIRECT
* SESSION_COOKIE_SECURE
* CSRF_COOKIE_SECURE
* SECURE_HSTS_SECONDS
* DATABASE
  * NAME
  * USER
  * PASSWORD
  * HOST
* ALLOWED_HOSTS
* INTERNAL_IPS
* LANGUAGE_CODE
* WAGTAIL_SITE_NAME
* BASE_URL
* CACHES
  * BACKEND
  * LOCATION
* WAGTAIL_SEARCH_BACKENDS
  * BACKEND
  * INDEX
* REST_FRAMEWORK
  * DEFAULT_PERMISSION_CLASSES
  * PAGE_SIZE
  * DEFAULT_PAGINATION_CLASS

**Note: Do NOT INCLUDE local.py in any git repos!**
	
### Initialise django, wagtail and the applications

	cd /var/www/wagtail/siteroot
	./manage.py makemigrations
	
**Usually requires `makemigrations` per app:**

	./manage.py makemigrations siteconfig
	./manage.py makemigrations sitecore
	./manage.py makemigrations siteuser
	./manage.py makemigrations search

	./manage.py makemigrations home
	./manage.py makemigrations article
	
Perform initial migration:

	./manage.py migrate

Superuser and static commands:

	./manage.py createsuperuser
		{overseer/**password**}
	./manage.py update_index
	./manage.py collectstatic

If some initial site data is required, optionally load any fixture data if provided:

	./manage.py load_fixtures [TBC]

Perform final initial migration:

	./manage.py migrate
	
### Enable/Start Services

	a2ensite wagtail-le-ssl
	apache2ctl restart
	
## Notes for Development Mode

If DEBUG is enabled run in dev mode on localhost ONLY. Debug information is output on the pages and may compromise security. Use an SSH tunnel to access via a remote machine and browser.

## Live site

Enable the production settings and **ensure DEBUG mode is DISABLED**, along with any toolbars.

Go to:
*	https://<your-host> for site
*	https://<your-host>/admin for Wagtail CMS Admin
*	https://<your-host>/django-admin for the default Django app admin
	
## Service cron jobs (TBC)

Need to consider:
*	le-ssl cert renewal...
*	update_index
*	session clearout

## Site Administration

1. Login to the /admin page using the superuser account created earlier. By default Wagtail installs a basic home page and needs to be replaced.
1. On the left-hand admin menu, select *Pages* and then *Pages* in the pop-out menu.
1. The **Root** page should now display a list of pages including the default *Welcome to your new Wagtail site*
1. Select *ADD CHILD PAGE*
1. Select *Home page* as the type of page (model) to use.
1. Provide a title, and at least one Body block (Markdown paragraph is recommended)
1. Select *Publish* in the menu at the bottom of the page.
1. Back on the main left-hand admin menu, select *Settings* and *Sites*
1. On the **SITES** page, select the *locahost* site to edit it.
1. Uncheck the *Is default site*.
1. Select *SAVE*.
1. Back on the **SITES** page, select *ADD A SITE*
1. Enter the your.fqdn (or localhost), the port (80 for HTTP, 443 for HTTPS), the site name, then select the newly created home page. Check *Is default site* if required (recommended).
1. Select *SAVE*

You should now have a new home page.

# References

* http://www.revsys.com/writings/quicktips/ssh-tunnel.html -
